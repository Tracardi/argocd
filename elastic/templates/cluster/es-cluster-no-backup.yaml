apiVersion: elasticsearch.k8s.elastic.co/v1
kind: Elasticsearch
metadata:
  name: cluster
spec:
  version: {{ .Values.version }}
  http:
    service:
      spec:
        type: {{ .Values.service.type }}  # default ClusterIp
        ports:
          - name: https
            protocol: TCP
            port: {{ .Values.service.port }}
  nodeSets:
  - name: master-node
    count: {{ .Values.master.replicas }}
    config:
      node.roles: [ "master" ]
      node.store.allow_mmap: false
    volumeClaimTemplates:
      - metadata:
          name: elasticsearch-data
        spec:
          accessModes:
            - ReadWriteOnce
          resources:
            requests:
              storage: {{ .Values.master.storage.size }}
          storageClassName: {{ .Values.master.storage.className }}
    podTemplate:
      spec:
        initContainers:
          - name: sysctl
            securityContext:
              privileged: true
              runAsUser: 0
            command: [ 'sh', '-c', 'sysctl -w vm.max_map_count=262144' ]

  - name: data-node
    count: {{ .Values.data.replicas }}
    config:
      node.roles: [ "data" ]
    volumeClaimTemplates:
      - metadata:
          name: elasticsearch-data
        spec:
          accessModes:
            - ReadWriteOnce
          resources:
            requests:
              storage: {{ .Values.data.storage.size }}
          storageClassName: {{ .Values.data.storage.className }}
    podTemplate:
      spec:
        initContainers:
          - name: sysctl
            securityContext:
              privileged: true
              runAsUser: 0
            command: [ 'sh', '-c', 'sysctl -w vm.max_map_count=262144' ]

#  - name: transform-node
#    count: 1
#    config:
#      node.roles: [ "transform" ]
#    volumeClaimTemplates:
#      - metadata:
#          name: elasticsearch-data
#        spec:
#          accessModes:
#            - ReadWriteOnce
#          resources:
#            requests:
#              storage: 50Gi
#    podTemplate:
#      spec:
#        initContainers:
#          - name: sysctl
#            securityContext:
#              privileged: true
#              runAsUser: 0
#            command: [ 'sh', '-c', 'sysctl -w vm.max_map_count=262144' ]
